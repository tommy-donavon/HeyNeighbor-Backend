version: "3"

services:
  consul:
    image: consul:latest
    ports:
      - "8300:8300"
      - "8400:8400"
      - "8500:8500"
  nginx-data:
    build:
      context: ./nginx
      dockerfile: Dockerfile
  gateway:
    image: seges/nginx-consul:1.9.0
    container_name: gateway
    volumes_from:
      - nginx-data
    ports:
      - 8080:80
  users-db:
    image: postgres:latest
    container_name: users-db
    restart: unless-stopped
    environment: 
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - APP_DB_USER=admin
      - APP_DB_PASS=${POSTGRES_PASSWORD}
      - APP_DB_NAME=users
    ports: 
      - '5438:5432'
    volumes: 
      - ./users-db/config:/docker-entrypoint-initdb.d/
  users-service:
    image: meaty/usersapi
    build: 
      context: ./users-service
      dockerfile: Dockerfile
    environment: 
      - DSN=host=users-db user=admin password=${POSTGRES_PASSWORD} dbname=users port=5432 sslmode=disable
      - PORT=:8080
      - CONSUL_HTTP_ADDR=consul:8500
    depends_on: 
      - users-db
  # message-broker:
  #   image: rabbitmq:3-management
  #   container_name: message-broker
  #   hostname: rabbit 
  #   ports: 
  #     - '5672:5672'
  #     - '15672:15672'